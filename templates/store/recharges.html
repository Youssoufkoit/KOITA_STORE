{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Barre de Recherche et Filtres Compacte -->
<section class="search-filter-compact">
    <div class="compact-search-container">
        <form method="get" action="{% url 'store:recharges' %}" class="compact-form">
            <!-- Ligne unique avec recherche + tri -->
            <div class="search-filter-row">
                <div class="search-input-wrapper">
                    <i class="fas fa-search"></i>
                    <input 
                        type="text" 
                        name="search" 
                        placeholder="Rechercher..." 
                        value="{{ search_query }}"
                        class="compact-input"
                    >
                </div>
                
                <select name="sort" onchange="this.form.submit()" class="compact-select">
                    <option value="default" {% if sort_by == 'default' %}selected{% endif %}>Trier par</option>
                    <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Plus récents</option>
                    <option value="price_asc" {% if sort_by == 'price_asc' %}selected{% endif %}>Prix ↑</option>
                    <option value="price_desc" {% if sort_by == 'price_desc' %}selected{% endif %}>Prix ↓</option>
                    <option value="name" {% if sort_by == 'name' %}selected{% endif %}>A-Z</option>
                </select>
                
                <button type="submit" class="compact-search-btn">
                    <i class="fas fa-search"></i>
                </button>
                
                {% if selected_category or search_query %}
                <a href="{% url 'store:recharges' %}" class="compact-clear-btn" title="Effacer les filtres">
                    <i class="fas fa-times"></i>
                </a>
                {% endif %}
            </div>
        </form>
    </div>
</section>

<!-- Catégories avec Cartes Visuelles (comme dans l'image) -->
<section class="categories-visual">
    <h2><i class="fas fa-layer-group"></i> Catégories Populaires</h2>
    
    <div class="categories-carousel">
        <!-- Toutes les catégories -->
        <a href="{% url 'store:recharges' %}" class="category-visual-card {% if not selected_category %}active{% endif %}">
            <div class="card-gradient gradient-all"></div>
            <div class="card-icon">
                <i class="fas fa-th-large"></i>
            </div>
            <div class="card-content">
                <h3>Tout</h3>
                <span class="product-count">{{ total_products }}</span>
            </div>
            <div class="card-shine"></div>
        </a>
        
        {% for category in categories %}
        <a href="{% url 'store:recharges' %}?category={{ category.slug }}" 
           class="category-visual-card {% if selected_category.id == category.id %}active{% endif %}">
            <div class="card-gradient gradient-{{ forloop.counter }}"></div>
            <div class="card-icon">
                <i class="{{ category.icon }}"></i>
            </div>
            <div class="card-content">
                <h3>{{ category.name }}</h3>
                <span class="product-count">{{ category.products.count }}</span>
            </div>
            <div class="card-shine"></div>
        </a>
        {% endfor %}
    </div>
</section>

<!-- Produits avec animations -->
<section class="products-showcase">
    <div class="showcase-header">
        <div class="header-left">
            <h2>
                {% if selected_category %}
                    {{ selected_category.name }}
                {% elif search_query %}
                    Résultats: "{{ search_query }}"
                {% else %}
                    Nos Produits
                {% endif %}
            </h2>
            <span class="result-count">{{ products.count }} article{{ products.count|pluralize }}</span>
        </div>
    </div>
    
    {% if products %}
    <div class="products-grid-modern">
        {% for product in products %}
        <div class="modern-product-card" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|add:0|divisibleby:4|yesno:'0,100,200,300' }}">
            <!-- Badge coin supérieur -->
            {% if product.is_featured %}
            <div class="corner-badge featured">
                <i class="fas fa-star"></i>
            </div>
            {% endif %}
            
            <!-- Image avec overlay -->
            <div class="product-image-wrapper">
                {% if product.image %}
                    <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-img">
                {% else %}
                    <div class="product-img-placeholder">
                        <i class="fas fa-image"></i>
                    </div>
                {% endif %}
                
                <!-- Overlay avec action rapide -->
                <div class="quick-view-overlay">
                    <a href="{% url 'store:product_detail' product.pk %}" class="quick-view-btn">
                        <i class="fas fa-eye"></i> Détails
                    </a>
                </div>
                
                <!-- Badge de stock -->
                {% if product.get_stock_status == 'low_stock' %}
                <span class="stock-indicator warning">
                    <i class="fas fa-exclamation-circle"></i> Stock limité
                </span>
                {% elif product.get_stock_status == 'out_of_stock' %}
                <span class="stock-indicator danger">
                    <i class="fas fa-times-circle"></i> Rupture
                </span>
                {% endif %}
            </div>
            
            <!-- Contenu du produit -->
            <div class="product-content">
                <!-- Catégorie tag -->
                <div class="product-category-badge">
                    <i class="{{ product.category.icon }}"></i>
                    {{ product.category.name }}
                </div>
                
                <!-- Nom du produit -->
                <h3 class="product-title">{{ product.name }}</h3>
                
                <!-- Description courte -->
                <p class="product-desc">{{ product.description|truncatechars:60 }}</p>
                
                <!-- Prix et action -->
                <div class="product-footer-modern">
                    <div class="price-section">
                        <span class="price-amount">{{ product.price|floatformat:0 }}</span>
                        <span class="price-currency">FCFA</span>
                    </div>
                    
                    <!-- Bouton d'ajout -->
                    {% if product.is_available %}
                    <form action="{% url 'cart:add_to_cart' product.id %}" method="post" class="quick-add-form">
                        {% csrf_token %}
                        <button type="submit" class="add-cart-btn">
                            <i class="fas fa-shopping-cart"></i>
                            <span>Ajouter</span>
                        </button>
                    </form>
                    {% else %}
                    <button class="add-cart-btn disabled" disabled>
                        <i class="fas fa-ban"></i>
                        <span>Indisponible</span>
                    </button>
                    {% endif %}
                </div>
                
                <!-- Stock disponible -->
                {% if product.is_available %}
                <div class="stock-info-bottom">
                    <i class="fas fa-box"></i> {{ product.stock }} disponible{{ product.stock|pluralize }}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    
    {% else %}
    <!-- État vide -->
    <div class="empty-state-modern">
        <div class="empty-icon">
            <i class="fas fa-search"></i>
        </div>
        <h3>Aucun produit trouvé</h3>
        <p>
            {% if search_query %}
                Aucun résultat pour "{{ search_query }}"
            {% else %}
                Aucun produit dans cette catégorie
            {% endif %}
        </p>
        <a href="{% url 'store:recharges' %}" class="btn-back-home">
            <i class="fas fa-arrow-left"></i> Voir tous les produits
        </a>
    </div>
    {% endif %}
</section>

<style>
/* ========================================
   BARRE DE RECHERCHE COMPACTE
======================================== */
.search-filter-compact {
    margin-bottom: 2rem;
}

.compact-search-container {
    background: var(--white);
    padding: 1rem 1.5rem;
    border-radius: 15px;
    border: 2px solid var(--border-color);
    box-shadow: 0 4px 15px var(--shadow-light);
}

.search-filter-row {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.search-input-wrapper {
    flex: 1;
    position: relative;
    display: flex;
    align-items: center;
    background: var(--light-gray);
    border-radius: 10px;
    padding: 0 1rem;
}

.search-input-wrapper i {
    color: var(--primary-orange);
    margin-right: 0.8rem;
}

.compact-input {
    flex: 1;
    border: none;
    background: transparent;
    padding: 0.9rem 0;
    font-size: 1rem;
    font-family: "Raleway", sans-serif;
    outline: none;
}

.compact-select {
    padding: 0.9rem 1.2rem;
    border: 2px solid var(--border-color);
    border-radius: 10px;
    background: var(--white);
    font-family: "Montserrat", sans-serif;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.compact-select:focus {
    border-color: var(--primary-orange);
}

.compact-search-btn {
    padding: 0.9rem 1.5rem;
    background: linear-gradient(135deg, var(--primary-orange), var(--dark-orange));
    color: var(--white);
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 1.1rem;
}

.compact-search-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px var(--orange-glow);
}

.compact-clear-btn {
    padding: 0.9rem;
    background: #e74c3c;
    color: var(--white);
    border-radius: 10px;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.compact-clear-btn:hover {
    background: #c0392b;
    transform: scale(1.1);
}

/* ========================================
   CATÉGORIES VISUELLES (STYLE IMAGE)
======================================== */
.categories-visual {
    margin-bottom: 3rem;
}

.categories-visual h2 {
    color: var(--secondary-blue);
    font-size: 2rem;
    font-family: "Bebas Neue", sans-serif;
    letter-spacing: 2px;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.8rem;
}

.categories-carousel {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    padding: 0.5rem;
}

.category-visual-card {
    position: relative;
    height: 140px;
    border-radius: 20px;
    overflow: hidden;
    text-decoration: none;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    box-shadow: 0 8px 25px var(--shadow-light);
    cursor: pointer;
}

.category-visual-card:hover {
    transform: translateY(-10px) scale(1.03);
    box-shadow: 0 15px 40px var(--shadow-medium);
}

.category-visual-card.active {
    transform: translateY(-5px) scale(1.05);
    box-shadow: 0 20px 50px rgba(255, 107, 53, 0.5);
}

/* Gradients différents pour chaque catégorie */
.card-gradient {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
}

.gradient-all {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.gradient-1 {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.gradient-2 {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.gradient-3 {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

.gradient-4 {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
}

.card-icon {
    position: absolute;
    top: 20px;
    left: 20px;
    font-size: 2.5rem;
    color: rgba(255, 255, 255, 0.3);
    z-index: 2;
    transition: all 0.4s ease;
}

.category-visual-card:hover .card-icon {
    transform: scale(1.2) rotate(10deg);
    color: rgba(255, 255, 255, 0.5);
}

.card-content {
    position: absolute;
    bottom: 20px;
    left: 20px;
    z-index: 3;
    color: var(--white);
}

.card-content h3 {
    font-size: 1.3rem;
    font-family: "Montserrat", sans-serif;
    font-weight: 700;
    margin-bottom: 0.3rem;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

.product-count {
    display: inline-block;
    padding: 0.3rem 0.8rem;
    background: rgba(255, 255, 255, 0.25);
    border-radius: 15px;
    font-size: 0.85rem;
    font-weight: 600;
    backdrop-filter: blur(10px);
}

.card-shine {
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.2) 50%, transparent 70%);
    transform: rotate(45deg);
    transition: all 0.6s ease;
    z-index: 2;
    opacity: 0;
}

.category-visual-card:hover .card-shine {
    left: 100%;
    opacity: 1;
}

/* ========================================
   GRILLE DE PRODUITS MODERNE
======================================== */
.products-showcase {
    margin-top: 2rem;
}

.showcase-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--border-color);
}

.header-left h2 {
    font-size: 2rem;
    font-family: "Bebas Neue", sans-serif;
    color: var(--secondary-blue);
    letter-spacing: 2px;
    margin-bottom: 0.3rem;
}

.result-count {
    color: #666;
    font-size: 0.9rem;
    font-weight: 600;
}

.products-grid-modern {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 2rem;
}

.modern-product-card {
    background: var(--white);
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 8px 25px var(--shadow-light);
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    position: relative;
}

.modern-product-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 20px 50px var(--shadow-medium);
}

.corner-badge {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 45px;
    height: 45px;
    background: linear-gradient(135deg, #f39c12, #e67e22);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-size: 1.2rem;
    z-index: 10;
    box-shadow: 0 4px 15px rgba(243, 156, 18, 0.5);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
}

.product-image-wrapper {
    position: relative;
    height: 220px;
    overflow: hidden;
    background: var(--light-gray);
}

.product-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
}

.modern-product-card:hover .product-img {
    transform: scale(1.15);
}

.product-img-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #ccc;
    font-size: 4rem;
}

.quick-view-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.modern-product-card:hover .quick-view-overlay {
    opacity: 1;
}

.quick-view-btn {
    padding: 1rem 2rem;
    background: var(--white);
    color: var(--primary-orange);
    text-decoration: none;
    border-radius: 30px;
    font-weight: 700;
    font-family: "Montserrat", sans-serif;
    transition: all 0.3s ease;
}

.quick-view-btn:hover {
    background: var(--primary-orange);
    color: var(--white);
    transform: scale(1.1);
}

.stock-indicator {
    position: absolute;
    bottom: 15px;
    left: 15px;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    z-index: 5;
}

.stock-indicator.warning {
    background: rgba(243, 156, 18, 0.95);
    color: var(--white);
}

.stock-indicator.danger {
    background: rgba(231, 76, 60, 0.95);
    color: var(--white);
}

.product-content {
    padding: 1.5rem;
}

.product-category-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 1rem;
    background: linear-gradient(135deg, var(--secondary-blue), var(--light-blue));
    color: var(--white);
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 700;
    margin-bottom: 1rem;
}

.product-title {
    font-size: 1.2rem;
    font-family: "Montserrat", sans-serif;
    font-weight: 700;
    color: var(--dark-gray);
    margin-bottom: 0.8rem;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.product-desc {
    color: #666;
    font-size: 0.9rem;
    line-height: 1.5;
    margin-bottom: 1.2rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.product-footer-modern {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 1rem;
    border-top: 2px solid var(--border-color);
    margin-bottom: 0.8rem;
}

.price-section {
    display: flex;
    align-items: baseline;
    gap: 0.3rem;
}

.price-amount {
    font-size: 1.8rem;
    font-weight: 800;
    font-family: "Bebas Neue", sans-serif;
    color: var(--primary-orange);
}

.price-currency {
    font-size: 0.9rem;
    color: #666;
    font-weight: 600;
}

.quick-add-form {
    display: contents;
}

.add-cart-btn {
    padding: 0.7rem 1.2rem;
    background: linear-gradient(135deg, var(--primary-orange), var(--dark-orange));
    color: var(--white);
    border: none;
    border-radius: 25px;
    font-weight: 700;
    font-family: "Montserrat", sans-serif;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
}

.add-cart-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px var(--orange-glow);
}

.add-cart-btn.disabled {
    background: #95a5a6;
    cursor: not-allowed;
    opacity: 0.6;
}

.stock-info-bottom {
    text-align: center;
    color: #27ae60;
    font-size: 0.85rem;
    font-weight: 600;
}

/* État vide */
.empty-state-modern {
    text-align: center;
    padding: 5rem 2rem;
}

.empty-icon {
    font-size: 5rem;
    color: var(--primary-orange);
    margin-bottom: 1.5rem;
    opacity: 0.5;
}

.empty-state-modern h3 {
    font-size: 2rem;
    font-family: "Bebas Neue", sans-serif;
    color: var(--dark-gray);
    margin-bottom: 1rem;
}

.empty-state-modern p {
    color: #666;
    font-size: 1.1rem;
    margin-bottom: 2rem;
}

.btn-back-home {
    display: inline-flex;
    align-items: center;
    gap: 0.8rem;
    padding: 1rem 2rem;
    background: linear-gradient(135deg, var(--primary-orange), var(--dark-orange));
    color: var(--white);
    text-decoration: none;
    border-radius: 30px;
    font-weight: 700;
    font-family: "Montserrat", sans-serif;
    transition: all 0.3s ease;
}

.btn-back-home:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px var(--orange-glow);
}

/* RESPONSIVE */
@media (max-width: 768px) {
    .search-filter-row {
        flex-wrap: wrap;
    }
    
    .search-input-wrapper {
        flex: 1 1 100%;
        margin-bottom: 0.5rem;
    }
    
    .compact-select {
        flex: 1;
    }
    
    .categories-carousel {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
    
    .category-visual-card {
        height: 120px;
    }
    
    .products-grid-modern {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
}

@media (max-width: 480px) {
    .categories-carousel {
        grid-template-columns: 1fr;
    }
    
    .card-content h3 {
        font-size: 1.1rem;
    }
}
</style>

<!-- AOS Animation Library (optionnel) -->
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<script>
    AOS.init({
        duration: 800,
        once: true,
        offset: 100
    });
</script>
{% endblock %}